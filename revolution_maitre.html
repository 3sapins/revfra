<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J'ai v√©cu la R√©volution - Ma√Ætre du jeu</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root { --bleu-roi: #002654; --blanc-royal: #f5f0e6; --rouge-sang: #a41c1c; --or-ancien: #c9a227; --parchemin: #f4edd3; --encre: #1a1a1a; --sepia: #704214; --vert-laurier: #2d5a3d; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { min-height: 100vh; background: linear-gradient(135deg, var(--encre) 0%, #1a1a2e 100%); font-family: 'EB Garamond', Georgia, serif; color: var(--blanc-royal); line-height: 1.6; }
        .header { background: linear-gradient(180deg, var(--bleu-roi) 0%, #001a3d 100%); border-bottom: 4px solid var(--or-ancien); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-title { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 700; }
        .header-info { display: flex; align-items: center; gap: 2rem; }
        .game-code { background: var(--or-ancien); color: var(--encre); padding: 0.5rem 1rem; font-family: 'Cinzel', serif; font-weight: 900; font-size: 1.3rem; letter-spacing: 3px; }
        .player-count { font-family: 'Cinzel', serif; }
        .player-count span { color: var(--or-ancien); font-weight: 700; }
        .main-container { display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem; padding: 1.5rem; max-width: 1500px; margin: 0 auto; }
        .situation-panel { background: var(--blanc-royal); color: var(--encre); border: 3px solid var(--sepia); }
        .situation-header { background: linear-gradient(135deg, var(--bleu-roi) 0%, #001a3d 100%); color: var(--blanc-royal); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .situation-year { font-family: 'Cinzel', serif; font-size: 3rem; font-weight: 900; }
        .situation-acte { font-family: 'Cinzel', serif; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.8; }
        .situation-icon { font-size: 3.5rem; }
        .situation-body { padding: 2rem; }
        .situation-title { font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--bleu-roi); margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--sepia); }
        .situation-text { font-size: 1.15rem; line-height: 1.9; margin-bottom: 1.5rem; }
        .situation-text .term { color: var(--rouge-sang); font-style: italic; cursor: help; border-bottom: 1px dotted var(--rouge-sang); position: relative; }
        .term:hover::after { content: attr(data-def); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--encre); color: var(--blanc-royal); padding: 0.8rem; font-size: 0.85rem; font-style: normal; width: 250px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .situation-question { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--sepia); margin: 1.5rem 0; font-weight: 700; }
        .choices-list { display: flex; flex-direction: column; gap: 0.6rem; margin-bottom: 1.5rem; }
        .choice-item { background: var(--parchemin); border: 2px solid rgba(112,66,20,0.3); padding: 0.8rem 1.2rem; display: flex; align-items: flex-start; gap: 0.8rem; }
        .choice-letter { background: var(--bleu-roi); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; }
        .savoir-plus-box { background: linear-gradient(135deg, #e8f4e8, #d4edda); border: 2px solid var(--vert-laurier); padding: 1.5rem; margin-top: 1rem; }
        .savoir-plus-title { font-family: 'Cinzel', serif; font-size: 1rem; color: var(--vert-laurier); margin-bottom: 0.8rem; }
        .savoir-plus-content { font-size: 0.95rem; line-height: 1.6; }
        .savoir-plus-content h4 { color: var(--vert-laurier); margin: 0.8rem 0 0.3rem; font-size: 0.95rem; }
        .savoir-plus-content ul { margin: 0.3rem 0; padding-left: 1.2rem; }
        .control-bar { background: var(--encre); border-top: 2px solid var(--or-ancien); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .responses-status { font-family: 'Cinzel', serif; }
        .responses-status .count { color: var(--or-ancien); font-size: 1.4rem; font-weight: 900; }
        .control-buttons { display: flex; gap: 1rem; }
        .btn { padding: 0.7rem 1.5rem; font-family: 'Cinzel', serif; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(180deg, var(--rouge-sang) 0%, #7a1515 100%); color: var(--blanc-royal); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { background: #666; cursor: not-allowed; transform: none; }
        .btn-secondary { background: linear-gradient(180deg, var(--bleu-roi) 0%, #001a3d 100%); color: var(--blanc-royal); }
        .btn-gold { background: linear-gradient(180deg, var(--or-ancien) 0%, #a68521 100%); color: var(--encre); }
        .rankings-panel { display: flex; flex-direction: column; gap: 1rem; }
        .ranking-card { background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); padding: 0.8rem; flex: 1; }
        .ranking-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding-bottom: 0.4rem; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .ranking-icon { font-size: 1.3rem; }
        .ranking-title { font-family: 'Cinzel', serif; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .ranking-card.lumieres { border-color: #ffd700; }
        .ranking-card.lumieres .ranking-header { color: #ffd700; }
        .ranking-card.histoire { border-color: #4a90d9; }
        .ranking-card.histoire .ranking-header { color: #4a90d9; }
        .ranking-card.ancien { border-color: #c0c0c0; }
        .ranking-card.ancien .ranking-header { color: #c0c0c0; }
        .ranking-list { list-style: none; }
        .ranking-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; font-size: 0.9rem; }
        .ranking-position { font-family: 'Cinzel', serif; font-weight: 900; width: 20px; text-align: center; }
        .ranking-position.gold { color: #ffd700; }
        .ranking-position.silver { color: #c0c0c0; }
        .ranking-position.bronze { color: #cd7f32; }
        .ranking-name { flex: 1; }
        .ranking-score { font-family: 'Cinzel', serif; font-weight: 700; color: var(--or-ancien); }
        .progress-card { background: rgba(255,255,255,0.05); border: 2px solid var(--or-ancien); padding: 0.8rem; }
        .progress-title { font-family: 'Cinzel', serif; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.4rem; color: var(--or-ancien); }
        .progress-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--bleu-roi), var(--rouge-sang)); transition: width 0.5s ease; }
        .progress-text { text-align: center; margin-top: 0.4rem; font-size: 0.85rem; }
        .setup-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .setup-card { background: var(--blanc-royal); color: var(--encre); border: 4px solid var(--sepia); padding: 3rem; max-width: 550px; width: 100%; text-align: center; }
        .setup-title { font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--bleu-roi); margin-bottom: 0.5rem; }
        .setup-subtitle { font-size: 1.2rem; color: var(--rouge-sang); margin-bottom: 2rem; font-style: italic; }
        .qr-container { background: white; padding: 1rem; display: inline-block; margin: 1rem 0; border: 2px solid var(--sepia); }
        .join-url { font-family: monospace; font-size: 0.9rem; background: var(--parchemin); padding: 0.6rem 1rem; border: 1px solid var(--sepia); margin: 1rem 0; word-break: break-all; }
        .waiting-text { font-size: 1.1rem; color: var(--sepia); margin: 1rem 0; }
        .players-waiting { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin: 1rem 0; }
        .player-chip { background: var(--bleu-roi); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.85rem; }
        .end-screen { padding: 2rem; max-width: 1100px; margin: 0 auto; }
        .end-title { font-family: 'Cinzel', serif; font-size: 2.2rem; text-align: center; margin-bottom: 2rem; color: var(--or-ancien); }
        .final-rankings { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .final-ranking-card { background: rgba(255,255,255,0.05); border: 3px solid; padding: 1.5rem; }
        .final-ranking-card.lumieres { border-color: #ffd700; }
        .final-ranking-card.histoire { border-color: #4a90d9; }
        .final-ranking-card.ancien { border-color: #c0c0c0; }
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 0.8rem; margin: 1rem 0; }
        .podium-place { text-align: center; padding: 0.8rem; min-width: 80px; }
        .podium-place.first { background: linear-gradient(180deg, #ffd700, #b8860b); color: var(--encre); padding-bottom: 2.5rem; }
        .podium-place.second { background: linear-gradient(180deg, #c0c0c0, #808080); color: var(--encre); padding-bottom: 1.8rem; }
        .podium-place.third { background: linear-gradient(180deg, #cd7f32, #8b4513); color: white; padding-bottom: 1.2rem; }
        .podium-name { font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.95rem; }
        .podium-score { font-size: 0.8rem; opacity: 0.8; }
        .class-stats { background: rgba(255,255,255,0.05); border: 2px solid var(--or-ancien); padding: 1.5rem; margin-top: 2rem; }
        .stats-title { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--or-ancien); margin-bottom: 1rem; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .stat-item { text-align: center; padding: 0.8rem; background: rgba(255,255,255,0.05); }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.8rem; font-weight: 900; color: var(--or-ancien); }
        .stat-label { font-size: 0.85rem; opacity: 0.8; }
        .hidden { display: none !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse 1.5s ease infinite; }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } .final-rankings { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="setup-screen" id="setupScreen">
        <div class="setup-card">
            <h1 class="setup-title">üèõÔ∏è J'ai v√©cu la R√©volution</h1>
            <p class="setup-subtitle">Mode Ma√Ætre du Jeu</p>
            <div id="createSection">
                <p style="margin-bottom: 1.5rem;">Cr√©ez une partie et partagez le code avec vos √©l√®ves.</p>
                <button class="btn btn-primary" id="createGameBtn" style="font-size: 1.1rem; padding: 1rem 2.5rem;">Cr√©er une partie</button>
            </div>
            <div id="waitingSection" class="hidden">
                <div class="qr-container"><canvas id="qrCode"></canvas></div>
                <div class="game-code" style="font-size: 2rem; letter-spacing: 5px; margin: 1rem 0;" id="displayCode">XXXX</div>
                <div class="join-url" id="joinUrl">URL de connexion</div>
                <p class="waiting-text pulse">En attente des joueurs...</p>
                <div class="players-waiting" id="playersWaiting"></div>
                <button class="btn btn-gold" id="startGameBtn" disabled style="margin-top: 1.5rem;">Lancer (<span id="playerCountSetup">0</span> joueurs)</button>
            </div>
        </div>
    </div>
    <div class="game-screen hidden" id="gameScreen">
        <header class="header">
            <div class="header-title">üèõÔ∏è R√©volution Fran√ßaise</div>
            <div class="header-info">
                <div class="player-count">Joueurs : <span id="playerCount">0</span></div>
                <div class="game-code" id="headerCode">XXXX</div>
            </div>
        </header>
        <div class="main-container">
            <div class="situation-panel">
                <div class="situation-header">
                    <div><div class="situation-year" id="situationYear">1789</div><div class="situation-acte" id="situationActe">Acte I</div></div>
                    <div class="situation-icon" id="situationIcon">üìú</div>
                </div>
                <div class="situation-body">
                    <h2 class="situation-title" id="situationTitle">Titre</h2>
                    <div class="situation-text" id="situationText"></div>
                    <p class="situation-question" id="situationQuestion"></p>
                    <div class="choices-list" id="choicesList"></div>
                    <div class="savoir-plus-box" id="savoirPlusBox"><div class="savoir-plus-title">üìö En savoir plus</div><div class="savoir-plus-content" id="savoirPlusContent"></div></div>
                </div>
                <div class="control-bar">
                    <div class="responses-status">R√©ponses : <span class="count" id="responsesCount">0</span> / <span id="totalPlayers">0</span></div>
                    <div class="control-buttons"><button class="btn btn-primary" id="nextSituationBtn" disabled>Suivant ‚Üí</button></div>
                </div>
            </div>
            <div class="rankings-panel">
                <div class="progress-card"><div class="progress-title">Progression</div><div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div><div class="progress-text" id="progressText">1 / 29</div></div>
                <div class="ranking-card lumieres"><div class="ranking-header"><span class="ranking-icon">üèõÔ∏è</span><span class="ranking-title">Penseurs des Lumi√®res</span></div><ol class="ranking-list" id="rankingLumieres"></ol></div>
                <div class="ranking-card histoire"><div class="ranking-header"><span class="ranking-icon">üìú</span><span class="ranking-title">Acteurs de l'Histoire</span></div><ol class="ranking-list" id="rankingHistoire"></ol></div>
                <div class="ranking-card ancien"><div class="ranking-header"><span class="ranking-icon">üëë</span><span class="ranking-title">Ancien R√©gime</span></div><ol class="ranking-list" id="rankingAncien"></ol></div>
            </div>
        </div>
    </div>
    <div class="end-screen hidden" id="endScreen"></div>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyD13KgzVLlclck2HEsBF8cQp-x1tm18CSc",
    authDomain: "revolution-7714f.firebaseapp.com",
    databaseURL: "https://revolution-7714f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "revolution-7714f"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let gameCode = '', gameRef = null, currentSituation = 0, players = {};

const definitions = {"√âtats g√©n√©raux":"Assembl√©e des trois ordres pour conseiller le roi","cahier de dol√©ances":"Document listant les plaintes du peuple","Assembl√©e nationale":"Nom pris par le Tiers-√âtat le 17 juin 1789","Constitution":"Texte d√©finissant les r√®gles du pouvoir","Bastille":"Prison symbole de l'arbitraire royal","Grande Peur":"Panique dans les campagnes, √©t√© 1789","biens nationaux":"Propri√©t√©s confisqu√©es √† l'√âglise","sans-culottes":"R√©volutionnaires parisiens du peuple","Terreur":"P√©riode de r√©pression 1793-1794","guillotine":"Machine √† d√©capiter","Thermidor":"Chute de Robespierre","Directoire":"R√©gime 1795-1799","18 Brumaire":"Coup d'√âtat de Bonaparte","Consulat":"R√©gime dirig√© par Bonaparte","Concordat":"Accord avec le pape (1801)","blocus continental":"Interdiction de commerce avec l'Angleterre","Waterloo":"D√©faite finale de Napol√©on","Sainte-H√©l√®ne":"√éle d'exil de Napol√©on"};
const actes = [{id:1,nom:"La fin de l'Ancien R√©gime",periode:"1788-1789"},{id:2,nom:"La monarchie constitutionnelle",periode:"1789-1792"},{id:3,nom:"La R√©publique et la Terreur",periode:"1792-1794"},{id:4,nom:"La R√©publique bourgeoise",periode:"1794-1799"},{id:5,nom:"Le Consulat et l'Empire",periode:"1799-1815"},{id:6,nom:"√âpilogue",periode:"1814-1821"}];
const situations = [
{id:1,acte:1,year:1789,title:"Les cahiers de dol√©ances",icon:"üìú",text:"L'hiver 1788 a √©t√© terrible. Louis XVI convoque les <em>√âtats g√©n√©raux</em>. Chaque ordre r√©dige un <em>cahier de dol√©ances</em>.",question:"C'est ton tour de parler. Que dis-tu ?",savoirPlus:"<h4>Les √âtats g√©n√©raux</h4><p>Assembl√©e des trois ordres. Derni√®re r√©union : 1614 !</p>",choices:[{text:"Le roi est bon, ses ministres l'ont mal conseill√©.",scores:{lumieres:0,histoire:1,ancien:2}},{text:"Abolissons les privil√®ges !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Il faut une r√©volution !",scores:{lumieres:1,histoire:0,ancien:0}},{text:"Je me propose comme d√©l√©gu√©.",scores:{lumieres:1,histoire:1,ancien:1}}]},
{id:2,acte:1,year:1789,title:"Le Serment du Jeu de Paume",icon:"‚úä",text:"Le Tiers-√âtat se proclame <em>Assembl√©e nationale</em> et jure de donner une <em>Constitution</em> √† la France.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>577 d√©put√©s ont pr√™t√© serment dans une salle de Jeu de Paume !</p>",choices:[{text:"Ces d√©put√©s sont des rebelles !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Quel courage !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Il faut abolir la monarchie !",scores:{lumieres:1,histoire:0,ancien:0}},{text:"Attendons de voir...",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:3,acte:1,year:1789,title:"La prise de la Bastille",icon:"üè∞",text:"14 juillet 1789. La foule prend la <em>Bastille</em>. Le gouverneur est massacr√©.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>La Bastille ne contenait que 7 prisonniers !</p>",choices:[{text:"Ces gens sont des sauvages !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"La libert√© est en marche !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Faisons pareil partout !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Mettons la cocarde.",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:4,acte:1,year:1789,title:"La nuit du 4 ao√ªt",icon:"üî•",text:"La <em>Grande Peur</em> pousse l'Assembl√©e √† abolir les privil√®ges.",question:"Qu'en penses-tu ?",savoirPlus:"<p>Fin de la soci√©t√© d'ordres en une nuit !</p>",choices:[{text:"Le seigneur avait des droits !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"L'Assembl√©e a bien fait.",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Partageons les terres !",scores:{lumieres:1,histoire:0,ancien:0}},{text:"J'ach√®te des terres.",scores:{lumieres:0,histoire:1,ancien:0}}]},
{id:5,acte:1,year:1789,title:"D√©claration des Droits",icon:"üìã",text:"L'Assembl√©e proclame : Les hommes naissent libres et √©gaux en droits.",question:"Qu'en penses-tu ?",savoirPlus:"<p>Texte fondateur, mais femmes exclues !</p>",choices:[{text:"Dieu a voulu des classes !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Une soci√©t√© juste !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Et les femmes ?",scores:{lumieres:2,histoire:0,ancien:0}},{text:"Et le prix du pain ?",scores:{lumieres:0,histoire:1,ancien:0}}]},
{id:6,acte:2,year:1789,title:"Les journ√©es d'octobre",icon:"üë©",text:"Des femmes marchent sur Versailles et ram√®nent le roi √† Paris.",question:"Ton avis ?",savoirPlus:"<p>Le boulanger, la boulang√®re et le petit mitron !</p>",choices:[{text:"Le roi prisonnier !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Il doit vivre parmi le peuple.",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Pendre des aristocrates !",scores:{lumieres:0,histoire:0,ancien:0}},{text:"Elles avaient faim.",scores:{lumieres:1,histoire:1,ancien:0}}]},
{id:7,acte:2,year:1790,title:"Constitution civile du clerg√©",icon:"‚õ™",text:"Les pr√™tres doivent pr√™ter serment. Ton cur√© a refus√©.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Division entre jureurs et r√©fractaires.</p>",choices:[{text:"J'aide le cur√© √† se cacher.",scores:{lumieres:0,histoire:0,ancien:2}},{text:"La loi est la loi.",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Bon d√©barras !",scores:{lumieres:0,histoire:0,ancien:0}},{text:"Je vais chez le nouveau cur√©.",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:8,acte:2,year:1790,title:"La F√™te de la F√©d√©ration",icon:"üéâ",text:"14 juillet 1790. Grande f√™te de l'unit√© nationale.",question:"Tu y participes ?",savoirPlus:"<p>300 000 personnes ! Le roi pr√™te serment.</p>",choices:[{text:"Voir le roi humili√© ? Jamais !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"J'y vais avec enthousiasme !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Le roi n'est pas sinc√®re.",scores:{lumieres:1,histoire:1,ancien:0}},{text:"√áa ne remplit pas les ventres.",scores:{lumieres:0,histoire:1,ancien:0}}]},
{id:9,acte:2,year:1791,title:"La fuite √† Varennes",icon:"üèÉ",text:"Le roi s'enfuit mais est arr√™t√©.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Reconnu gr√¢ce aux pi√®ces de monnaie !</p>",choices:[{text:"Pauvre roi prisonnier !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Donnons-lui une chance.",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Le roi est un tra√Ætre !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Attendons de voir...",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:10,acte:2,year:1792,title:"La d√©claration de guerre",icon:"‚öîÔ∏è",text:"La France d√©clare la guerre √† l'Autriche.",question:"Ton avis ?",savoirPlus:"<p>D√©but de 23 ans de guerres !</p>",choices:[{text:"L'ennemi r√©tablira le roi !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"D√©fendons la libert√© !",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Cette guerre est folle !",scores:{lumieres:2,histoire:0,ancien:0}},{text:"Je m'engage volontaire !",scores:{lumieres:1,histoire:2,ancien:0}}]},
{id:11,acte:3,year:1792,title:"La chute de la royaut√©",icon:"üèõÔ∏è",text:"10 ao√ªt 1792. Les <em>sans-culottes</em> prennent les Tuileries.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Fin de la monarchie mill√©naire !</p>",choices:[{text:"Sans roi, c'est perdu !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Place √† la R√©publique !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"J'ai particip√© !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Attendons de voir.",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:12,acte:3,year:1792,title:"Massacres de septembre",icon:"üíÄ",text:"Massacres dans les prisons de Paris.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>1 100 √† 1 400 morts en 5 jours.</p>",choices:[{text:"La R√©volution est folle !",scores:{lumieres:2,histoire:0,ancien:1}},{text:"La peur les a rendus fous.",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Le peuple a fait justice !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Je reste chez moi.",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:13,acte:3,year:1793,title:"L'ex√©cution du roi",icon:"‚ö∞Ô∏è",text:"21 janvier 1793. Louis XVI est guillotin√©.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>361 voix pour, 360 contre !</p>",choices:[{text:"Crime abominable !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Terrible mais n√©cessaire.",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Mort au tyran !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"L'exil aurait suffi.",scores:{lumieres:2,histoire:0,ancien:0}}]},
{id:14,acte:3,year:1793,title:"La Vend√©e",icon:"üéñÔ∏è",text:"La Vend√©e se r√©volte contre la lev√©e de 300 000 hommes.",question:"Ton jugement ?",savoirPlus:"<p>150 000 √† 300 000 morts.</p>",choices:[{text:"Ce sont des h√©ros !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Je comprends mais...",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Il faut les √©craser !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Ouf, pas tir√© au sort.",scores:{lumieres:0,histoire:1,ancien:0}}]},
{id:15,acte:3,year:1793,title:"Assassinat de Marat",icon:"üó°Ô∏è",text:"Charlotte Corday poignarde Marat.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>J'ai tu√© un homme pour en sauver cent mille.</p>",choices:[{text:"Elle est une h√©ro√Øne !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"L'assassinat est condamnable.",scores:{lumieres:2,histoire:1,ancien:0}},{text:"Marat √©tait l'ami du peuple !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Je garde mes opinions.",scores:{lumieres:0,histoire:2,ancien:1}}]},
{id:16,acte:3,year:1793,title:"La Terreur",icon:"üîí",text:"La <em>Terreur</em> est √† l'ordre du jour. La <em>guillotine</em> fonctionne tous les jours.",question:"Comment survis-tu ?",savoirPlus:"<p>17 000 ex√©cutions officielles.</p>",choices:[{text:"Je prie en secret.",scores:{lumieres:1,histoire:0,ancien:2}},{text:"C'est n√©cessaire.",scores:{lumieres:0,histoire:2,ancien:0}},{text:"Je d√©nonce un voisin.",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Je reste discret.",scores:{lumieres:1,histoire:2,ancien:1}}]},
{id:17,acte:3,year:1794,title:"Chute de Robespierre",icon:"‚ö°",text:"9 <em>Thermidor</em>. Robespierre est guillotin√©.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Fin de la Terreur.</p>",choices:[{text:"Vive le roi !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Tant mieux que c'est fini.",scores:{lumieres:2,histoire:2,ancien:0}},{text:"Les corrompus l'ont abattu !",scores:{lumieres:1,histoire:0,ancien:0}},{text:"On va respirer.",scores:{lumieres:1,histoire:2,ancien:0}}]},
{id:18,acte:4,year:1795,title:"Le Directoire",icon:"üèõÔ∏è",text:"Le <em>Directoire</em> remplace la Convention.",question:"Ton avis ?",savoirPlus:"<p>R√©gime instable et corrompu.</p>",choices:[{text:"Sans roi, c'est le chaos.",scores:{lumieres:0,histoire:0,ancien:2}},{text:"La Terreur est finie.",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Bourgeois tra√Ætres !",scores:{lumieres:2,histoire:0,ancien:0}},{text:"Tant qu'on fait des affaires.",scores:{lumieres:0,histoire:1,ancien:0}}]},
{id:19,acte:4,year:1796,title:"Bonaparte en Italie",icon:"‚öîÔ∏è",text:"Bonaparte remporte victoire sur victoire.",question:"Que penses-tu ?",savoirPlus:"<p>Il a 27 ans et devient un h√©ros.</p>",choices:[{text:"Un militaire dangereux.",scores:{lumieres:2,histoire:0,ancien:0}},{text:"Enfin un homme fort !",scores:{lumieres:0,histoire:2,ancien:1}},{text:"Il restaurera le roi ?",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Quand la paix ?",scores:{lumieres:1,histoire:1,ancien:0}}]},
{id:20,acte:4,year:1799,title:"Le 18 Brumaire",icon:"üé≠",text:"Bonaparte renverse le Directoire par un coup d'√âtat.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>La R√©volution est fix√©e... elle est finie.</p>",choices:[{text:"Mort de la libert√© !",scores:{lumieres:2,histoire:0,ancien:0}},{text:"Enfin un homme fort !",scores:{lumieres:0,histoire:2,ancien:1}},{text:"Il restaurera le roi ?",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Attendons de voir.",scores:{lumieres:1,histoire:2,ancien:0}}]},
{id:21,acte:5,year:1801,title:"Le Concordat",icon:"‚õ™",text:"Bonaparte signe le <em>Concordat</em> avec le pape.",question:"Qu'en penses-tu ?",savoirPlus:"<p>Paix religieuse retrouv√©e.</p>",choices:[{text:"On peut pratiquer !",scores:{lumieres:0,histoire:1,ancien:2}},{text:"Compromis intelligent.",scores:{lumieres:1,histoire:2,ancien:0}},{text:"Trahison !",scores:{lumieres:2,histoire:0,ancien:0}},{text:"Tant qu'on ne m'oblige pas.",scores:{lumieres:1,histoire:1,ancien:0}}]},
{id:22,acte:5,year:1804,title:"Le sacre",icon:"üëë",text:"Napol√©on se couronne empereur.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Il pose lui-m√™me la couronne sur sa t√™te.</p>",choices:[{text:"Le vrai roi est Louis XVIII !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"La R√©publique est morte.",scores:{lumieres:2,histoire:1,ancien:0}},{text:"Vive l'Empereur !",scores:{lumieres:0,histoire:2,ancien:0}},{text:"Roi ou empereur...",scores:{lumieres:0,histoire:1,ancien:1}}]},
{id:23,acte:5,year:1805,title:"Austerlitz",icon:"‚öîÔ∏è",text:"Napol√©on √©crase les Autrichiens et les Russes.",question:"Ta r√©action ?",savoirPlus:"<p>Le soleil d'Austerlitz - chef d'≈ìuvre tactique.</p>",choices:[{text:"L'ambition d'un seul.",scores:{lumieres:2,histoire:0,ancien:1}},{text:"Gloire √† l'Empereur !",scores:{lumieres:0,histoire:2,ancien:0}},{text:"Mon fils est mort.",scores:{lumieres:1,histoire:0,ancien:0}},{text:"Quand la paix ?",scores:{lumieres:2,histoire:1,ancien:0}}]},
{id:24,acte:5,year:1806,title:"Le blocus",icon:"üö¢",text:"Napol√©on interdit le commerce avec l'Angleterre.",question:"Comment t'adaptes-tu ?",savoirPlus:"<p>L'Europe souffre, l'industrie sucri√®re se d√©veloppe.</p>",choices:[{text:"L'Empereur sait.",scores:{lumieres:0,histoire:2,ancien:0}},{text:"Mon commerce est ruin√© !",scores:{lumieres:1,histoire:0,ancien:1}},{text:"Je fais de la contrebande.",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Je me reconvertis.",scores:{lumieres:0,histoire:2,ancien:0}}]},
{id:25,acte:5,year:1812,title:"Campagne de Russie",icon:"‚ùÑÔ∏è",text:"D√©sastre en Russie. Moins de 100 000 survivants sur 600 000.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>La B√©r√©zina devient synonyme de catastrophe.</p>",choices:[{text:"L'orgueil a tu√© nos fils.",scores:{lumieres:2,histoire:1,ancien:1}},{text:"L'Empereur fut trahi.",scores:{lumieres:0,histoire:1,ancien:0}},{text:"C'est la fin.",scores:{lumieres:1,histoire:2,ancien:1}},{text:"Mon fr√®re n'est pas revenu.",scores:{lumieres:2,histoire:1,ancien:0}}]},
{id:26,acte:5,year:1814,title:"L'abdication",icon:"üìú",text:"Napol√©on abdique. Louis XVIII revient.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Exil √† l'√Æle d'Elbe.</p>",choices:[{text:"Le roi est de retour !",scores:{lumieres:0,histoire:1,ancien:2}},{text:"Tout √ßa pour √ßa.",scores:{lumieres:2,histoire:1,ancien:0}},{text:"Napol√©on reviendra.",scores:{lumieres:0,histoire:2,ancien:0}},{text:"Je veux la paix.",scores:{lumieres:1,histoire:1,ancien:0}}]},
{id:27,acte:6,year:1815,title:"Les Cent-Jours",icon:"ü¶Ö",text:"Napol√©on s'√©vade et reconquiert le pouvoir.",question:"Comment r√©agis-tu ?",savoirPlus:"<p>Reconqu√™te sans tirer un coup de feu.</p>",choices:[{text:"L'usurpateur revient !",scores:{lumieres:0,histoire:0,ancien:2}},{text:"Vive l'Empereur !",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Encore la guerre...",scores:{lumieres:2,histoire:1,ancien:0}},{text:"Attendons de voir.",scores:{lumieres:0,histoire:2,ancien:1}}]},
{id:28,acte:6,year:1815,title:"Waterloo",icon:"‚öîÔ∏è",text:"<em>Waterloo</em>. D√©faite finale.",question:"Comment te sens-tu ?",savoirPlus:"<p>50 000 morts en une journ√©e.</p>",choices:[{text:"Le tyran est vaincu !",scores:{lumieres:0,histoire:1,ancien:2}},{text:"La gloire est perdue.",scores:{lumieres:0,histoire:1,ancien:0}},{text:"Enfin la paix !",scores:{lumieres:2,histoire:2,ancien:0}},{text:"C'√©tait un g√©nie.",scores:{lumieres:0,histoire:1,ancien:0}}]},
{id:29,acte:6,year:1821,title:"Mort de Napol√©on",icon:"‚ö∞Ô∏è",text:"Napol√©on meurt √† <em>Sainte-H√©l√®ne</em>.",question:"Quel bilan ?",savoirPlus:"<p>Son corps sera ramen√© aux Invalides en 1840.</p>",choices:[{text:"Bon d√©barras !",scores:{lumieres:1,histoire:0,ancien:2}},{text:"Un g√©ant de l'Histoire.",scores:{lumieres:0,histoire:2,ancien:0}},{text:"Il a trahi les id√©aux.",scores:{lumieres:2,histoire:1,ancien:0}},{text:"L'Histoire jugera.",scores:{lumieres:2,histoire:2,ancien:0}}]}
];

function generateGameCode() { const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r=''; for(let i=0;i<4;i++)r+=c.charAt(Math.floor(Math.random()*c.length)); return r; }

document.getElementById('createGameBtn').addEventListener('click', async function() {
    gameCode = generateGameCode();
    gameRef = database.ref('games/' + gameCode);
    await gameRef.set({ status: 'waiting', currentSituation: 0, createdAt: Date.now(), players: {} });
    document.getElementById('createSection').classList.add('hidden');
    document.getElementById('waitingSection').classList.remove('hidden');
    document.getElementById('displayCode').textContent = gameCode;
    const joinUrl = window.location.href.replace('maitre', 'eleve').split('?')[0] + '?code=' + gameCode;
    document.getElementById('joinUrl').textContent = joinUrl;
    QRCode.toCanvas(document.getElementById('qrCode'), joinUrl, { width: 180, margin: 2, color: { dark: '#002654' } });
    gameRef.child('players').on('value', (snapshot) => { players = snapshot.val() || {}; updatePlayersList(); });
});

function updatePlayersList() {
    const container = document.getElementById('playersWaiting');
    const names = Object.values(players).map(p => p.name);
    container.innerHTML = names.map(n => '<span class="player-chip">' + n + '</span>').join('');
    document.getElementById('playerCountSetup').textContent = names.length;
    document.getElementById('startGameBtn').disabled = names.length < 1;
}

document.getElementById('startGameBtn').addEventListener('click', async function() {
    await gameRef.update({ status: 'playing', currentSituation: 0 });
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    document.getElementById('headerCode').textContent = gameCode;
    renderSituation();
    listenToResponses();
});

function addTooltips(text) {
    return text.replace(/<em>([^<]+)<\/em>/g, function(m, t) {
        const d = definitions[t];
        return d ? '<span class="term" data-def="' + d.replace(/"/g, '&quot;') + '">' + t + '</span>' : '<span class="term">' + t + '</span>';
    });
}

function renderSituation() {
    const s = situations[currentSituation];
    const a = actes.find(x => x.id === s.acte);
    document.getElementById('situationYear').textContent = s.year;
    document.getElementById('situationActe').textContent = 'Acte ' + a.id + ' ‚Ä¢ ' + a.periode;
    document.getElementById('situationIcon').textContent = s.icon;
    document.getElementById('situationTitle').textContent = s.title;
    document.getElementById('situationText').innerHTML = addTooltips(s.text).replace(/\n/g, '<br>');
    document.getElementById('situationQuestion').textContent = s.question;
    const cl = document.getElementById('choicesList');
    cl.innerHTML = '';
    ['A','B','C','D'].forEach((l, i) => {
        if (s.choices[i]) {
            const d = document.createElement('div');
            d.className = 'choice-item';
            d.innerHTML = '<span class="choice-letter">' + l + '</span><span>' + s.choices[i].text + '</span>';
            cl.appendChild(d);
        }
    });
    if (s.savoirPlus) { document.getElementById('savoirPlusBox').classList.remove('hidden'); document.getElementById('savoirPlusContent').innerHTML = s.savoirPlus; }
    else { document.getElementById('savoirPlusBox').classList.add('hidden'); }
    const p = ((currentSituation + 1) / situations.length) * 100;
    document.getElementById('progressFill').style.width = p + '%';
    document.getElementById('progressText').textContent = (currentSituation + 1) + ' / ' + situations.length;
    document.getElementById('responsesCount').textContent = '0';
    document.getElementById('nextSituationBtn').disabled = true;
    if (gameRef) gameRef.update({ currentSituation });
    updateRankings();
}

function listenToResponses() {
    gameRef.child('players').on('value', (snapshot) => {
        players = snapshot.val() || {};
        let resp = 0;
        Object.values(players).forEach(p => { if (p.responses && p.responses[currentSituation] !== undefined) resp++; });
        const total = Object.keys(players).length;
        document.getElementById('responsesCount').textContent = resp;
        document.getElementById('totalPlayers').textContent = total;
        document.getElementById('playerCount').textContent = total;
        document.getElementById('nextSituationBtn').disabled = resp < total || total === 0;
        updateRankings();
    });
}

function updateRankings() {
    const scores = [];
    Object.entries(players).forEach(([id, p]) => {
        let l = 0, h = 0, a = 0;
        if (p.responses) {
            Object.entries(p.responses).forEach(([si, ci]) => {
                const sit = situations[parseInt(si)];
                if (sit && sit.choices[ci]) { l += sit.choices[ci].scores.lumieres || 0; h += sit.choices[ci].scores.histoire || 0; a += sit.choices[ci].scores.ancien || 0; }
            });
        }
        scores.push({ name: p.name, lumieres: l, histoire: h, ancien: a });
    });
    renderRanking('rankingLumieres', scores.slice().sort((a, b) => b.lumieres - a.lumieres), 'lumieres');
    renderRanking('rankingHistoire', scores.slice().sort((a, b) => b.histoire - a.histoire), 'histoire');
    renderRanking('rankingAncien', scores.slice().sort((a, b) => b.ancien - a.ancien), 'ancien');
}

function renderRanking(id, sorted, key) {
    const c = document.getElementById(id);
    c.innerHTML = '';
    sorted.slice(0, 6).forEach((p, i) => {
        const li = document.createElement('li');
        li.className = 'ranking-item';
        let pc = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        li.innerHTML = '<span class="ranking-position ' + pc + '">' + (i + 1) + '</span><span class="ranking-name">' + p.name + '</span><span class="ranking-score">' + p[key] + '</span>';
        c.appendChild(li);
    });
}

document.getElementById('nextSituationBtn').addEventListener('click', function() {
    if (currentSituation < situations.length - 1) { currentSituation++; renderSituation(); }
    else showEndScreen();
});

function showEndScreen() {
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('endScreen').classList.remove('hidden');
    const scores = [];
    Object.entries(players).forEach(([id, p]) => {
        let l = 0, h = 0, a = 0;
        if (p.responses) { Object.entries(p.responses).forEach(([si, ci]) => { const sit = situations[parseInt(si)]; if (sit && sit.choices[ci]) { l += sit.choices[ci].scores.lumieres || 0; h += sit.choices[ci].scores.histoire || 0; a += sit.choices[ci].scores.ancien || 0; } }); }
        scores.push({ name: p.name, lumieres: l, histoire: h, ancien: a });
    });
    const lTop = scores.slice().sort((a, b) => b.lumieres - a.lumieres);
    const hTop = scores.slice().sort((a, b) => b.histoire - a.histoire);
    const aTop = scores.slice().sort((a, b) => b.ancien - a.ancien);
    const avgL = scores.reduce((s, p) => s + p.lumieres, 0) / scores.length || 0;
    const avgH = scores.reduce((s, p) => s + p.histoire, 0) / scores.length || 0;
    const avgA = scores.reduce((s, p) => s + p.ancien, 0) / scores.length || 0;
    let tendency = avgH > avgL && avgH > avgA ? "üéØ Votre classe suit le cours de l'Histoire." : avgL > avgH && avgL > avgA ? "üèõÔ∏è Votre classe est fid√®le aux id√©aux des Lumi√®res." : "üëë Votre classe d√©fend l'ordre traditionnel.";
    document.getElementById('endScreen').innerHTML = '<h1 class="end-title">üèõÔ∏è Fin de la partie</h1><div class="final-rankings"><div class="final-ranking-card lumieres"><div class="ranking-header"><span class="ranking-icon">üèõÔ∏è</span><span class="ranking-title">Lumi√®res</span></div><div class="podium">' + (lTop[1] ? '<div class="podium-place second"><div class="podium-name">' + lTop[1].name + '</div><div class="podium-score">' + lTop[1].lumieres + '</div></div>' : '') + (lTop[0] ? '<div class="podium-place first"><div class="podium-name">' + lTop[0].name + '</div><div class="podium-score">' + lTop[0].lumieres + '</div></div>' : '') + (lTop[2] ? '<div class="podium-place third"><div class="podium-name">' + lTop[2].name + '</div><div class="podium-score">' + lTop[2].lumieres + '</div></div>' : '') + '</div></div><div class="final-ranking-card histoire"><div class="ranking-header"><span class="ranking-icon">üìú</span><span class="ranking-title">Histoire</span></div><div class="podium">' + (hTop[1] ? '<div class="podium-place second"><div class="podium-name">' + hTop[1].name + '</div><div class="podium-score">' + hTop[1].histoire + '</div></div>' : '') + (hTop[0] ? '<div class="podium-place first"><div class="podium-name">' + hTop[0].name + '</div><div class="podium-score">' + hTop[0].histoire + '</div></div>' : '') + (hTop[2] ? '<div class="podium-place third"><div class="podium-name">' + hTop[2].name + '</div><div class="podium-score">' + hTop[2].histoire + '</div></div>' : '') + '</div></div><div class="final-ranking-card ancien"><div class="ranking-header"><span class="ranking-icon">üëë</span><span class="ranking-title">Ancien R√©gime</span></div><div class="podium">' + (aTop[1] ? '<div class="podium-place second"><div class="podium-name">' + aTop[1].name + '</div><div class="podium-score">' + aTop[1].ancien + '</div></div>' : '') + (aTop[0] ? '<div class="podium-place first"><div class="podium-name">' + aTop[0].name + '</div><div class="podium-score">' + aTop[0].ancien + '</div></div>' : '') + (aTop[2] ? '<div class="podium-place third"><div class="podium-name">' + aTop[2].name + '</div><div class="podium-score">' + aTop[2].ancien + '</div></div>' : '') + '</div></div></div><div class="class-stats"><h2 class="stats-title">üìä Statistiques de la classe</h2><div class="stats-grid"><div class="stat-item"><div class="stat-value">' + scores.length + '</div><div class="stat-label">Joueurs</div></div><div class="stat-item"><div class="stat-value">' + avgL.toFixed(1) + '</div><div class="stat-label">Moy. Lumi√®res</div></div><div class="stat-item"><div class="stat-value">' + avgH.toFixed(1) + '</div><div class="stat-label">Moy. Histoire</div></div><div class="stat-item"><div class="stat-value">' + avgA.toFixed(1) + '</div><div class="stat-label">Moy. Ancien R.</div></div></div><p style="text-align:center;margin-top:1rem;opacity:0.8;">' + tendency + '</p></div><div style="text-align:center;margin-top:2rem;"><button class="btn btn-primary" onclick="location.reload()">Nouvelle partie</button></div>';
}
</script>
</body>
</html>
