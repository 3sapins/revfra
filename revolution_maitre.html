 title: "D√©claration des Droits de l'Homme", icon: "üìã",
      text: "L'Assembl√©e proclame : \"Les hommes naissent libres et √©gaux en droits.\"",
      question: "Qu'en penses-tu ?",
      savoirPlus: "<h4>La DDHC</h4><p>Texte fondateur, mais femmes exclues !</p>",
      choices: [
        { text: "Dieu a voulu des nobles et des paysans !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Les fondements d'une soci√©t√© juste !", scores: { lumieres: 2, histoire: 2, ancien: 0 } },
        { text: "Et les femmes ? Et les esclaves ?", scores: { lumieres: 2, histoire: 0, ancien: 0 } },
        { text: "√áa fera-t-il baisser le prix du pain ?", scores: { lumieres: 0, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 6, acte: 2, year: 1789, title: "Les journ√©es d'octobre", icon: "üë©",
      text: "Des femmes marchent sur Versailles et ram√®nent le roi √† Paris.",
      question: "Ton avis ?",
      savoirPlus: "<p>Le 'boulanger, la boulang√®re et le petit mitron' !</p>",
      choices: [
        { text: "Le roi prisonnier ! Quelle honte !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Le roi doit vivre parmi son peuple.", scores: { lumieres: 2, histoire: 2, ancien: 0 } },
        { text: "Il fallait pendre des aristocrates !", scores: { lumieres: 0, histoire: 0, ancien: 0 } },
        { text: "Ces femmes avaient faim, tout simplement.", scores: { lumieres: 1, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 7, acte: 2, year: 1790, title: "Constitution civile du clerg√©", icon: "‚õ™",
      text: "Les pr√™tres doivent pr√™ter serment. Ton cur√© a refus√©.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Division entre jureurs et r√©fractaires.</p>",
      choices: [
        { text: "Je l'aide √† se cacher.", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "La loi est la loi.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Bon d√©barras !", scores: { lumieres: 0, histoire: 0, ancien: 0 } },
        { text: "Je vais chez le nouveau cur√©. Prudence.", scores: { lumieres: 0, histoire: 1, ancien: 1 } }
      ]
    },
    { id: 8, acte: 2, year: 1790, title: "La F√™te de la F√©d√©ration", icon: "üéâ",
      text: "14 juillet 1790. Grande f√™te de l'unit√© nationale.",
      question: "Tu y participes ?",
      savoirPlus: "<p>300 000 personnes ! Le roi pr√™te serment.</p>",
      choices: [
        { text: "Voir le roi humili√© ? Jamais !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "J'y vais avec enthousiasme !", scores: { lumieres: 2, histoire: 2, ancien: 0 } },
        { text: "J'y vais mais le roi n'est pas sinc√®re.", scores: { lumieres: 1, histoire: 1, ancien: 0 } },
        { text: "La f√™te ne remplit pas les ventres.", scores: { lumieres: 0, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 9, acte: 2, year: 1791, title: "La fuite √† Varennes", icon: "üèÉ",
      text: "Le roi s'enfuit mais est arr√™t√© √† <em>Varennes</em>.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Reconnu gr√¢ce aux pi√®ces de monnaie !</p>",
      choices: [
        { text: "Pauvre roi prisonnier !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Donnons-lui une seconde chance.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Le roi est un tra√Ætre !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Attendons de voir...", scores: { lumieres: 0, histoire: 1, ancien: 1 } }
      ]
    },
    { id: 10, acte: 2, year: 1792, title: "La d√©claration de guerre", icon: "‚öîÔ∏è",
      text: "La France d√©clare la guerre √† l'Autriche.",
      question: "Ton avis ?",
      savoirPlus: "<p>D√©but de 23 ans de guerres !</p>",
      choices: [
        { text: "L'ennemi va r√©tablir le roi !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Nous d√©fendons la libert√© !", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Cette guerre est une folie !", scores: { lumieres: 2, histoire: 0, ancien: 0 } },
        { text: "Je m'engage comme volontaire !", scores: { lumieres: 1, histoire: 2, ancien: 0 } }
      ]
    },
    { id: 11, acte: 3, year: 1792, title: "La chute de la royaut√©", icon: "üèõÔ∏è",
      text: "10 ao√ªt 1792. Les <em>sans-culottes</em> prennent les Tuileries.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Fin de la monarchie mill√©naire !</p>",
      choices: [
        { text: "Sans roi, la France est perdue !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Place √† la R√©publique !", scores: { lumieres: 2, histoire: 2, ancien: 0 } },
        { text: "J'ai particip√© √† l'assaut !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Attendons de voir qui gouverne.", scores: { lumieres: 0, histoire: 1, ancien: 1 } }
      ]
    },
    { id: 12, acte: 3, year: 1792, title: "Les massacres de septembre", icon: "üíÄ",
      text: "Massacres dans les prisons de Paris.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>1 100 √† 1 400 morts en 5 jours.</p>",
      choices: [
        { text: "La R√©volution est folle !", scores: { lumieres: 2, histoire: 0, ancien: 1 } },
        { text: "La peur a rendu le peuple fou.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Le peuple a fait justice !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Je reste enferm√© chez moi.", scores: { lumieres: 0, histoire: 1, ancien: 1 } }
      ]
    },
    { id: 13, acte: 3, year: 1793, title: "L'ex√©cution du roi", icon: "‚ö∞Ô∏è",
      text: "21 janvier 1793. Louis XVI est guillotin√©.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>361 voix pour, 360 contre !</p>",
      choices: [
        { text: "Crime abominable !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "D√©cision terrible mais n√©cessaire.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Mort au tyran !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "L'exil aurait suffi.", scores: { lumieres: 2, histoire: 0, ancien: 0 } }
      ]
    },
    { id: 14, acte: 3, year: 1793, title: "La Vend√©e", icon: "üéñÔ∏è",
      text: "La Vend√©e se r√©volte contre la lev√©e de 300 000 hommes.",
      question: "Comment juges-tu cette r√©volte ?",
      savoirPlus: "<p>150 000 √† 300 000 morts.</p>",
      choices: [
        { text: "Ce sont des h√©ros !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Je comprends mais la patrie est en danger.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Il faut les √©craser !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Ouf, je n'ai pas √©t√© tir√© au sort.", scores: { lumieres: 0, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 15, acte: 3, year: 1793, title: "L'assassinat de Marat", icon: "üó°Ô∏è",
      text: "Charlotte Corday poignarde Marat.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>'J'ai tu√© un homme pour en sauver cent mille.'</p>",
      choices: [
        { text: "Elle est une h√©ro√Øne !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "L'assassinat politique est condamnable.", scores: { lumieres: 2, histoire: 1, ancien: 0 } },
        { text: "Marat √©tait l'ami du peuple !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Je garde mes opinions pour moi.", scores: { lumieres: 0, histoire: 2, ancien: 1 } }
      ]
    },
    { id: 16, acte: 3, year: 1793, title: "La Terreur", icon: "üîí",
      text: "La <em>Terreur</em> est √† l'ordre du jour. La <em>guillotine</em> fonctionne tous les jours.",
      question: "Comment survis-tu ?",
      savoirPlus: "<p>17 000 ex√©cutions officielles.</p>",
      choices: [
        { text: "Je prie pour la fin de ce cauchemar.", scores: { lumieres: 1, histoire: 0, ancien: 2 } },
        { text: "C'est n√©cessaire pour sauver la R√©publique.", scores: { lumieres: 0, histoire: 2, ancien: 0 } },
        { text: "Je d√©nonce un voisin suspect.", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Je reste discret.", scores: { lumieres: 1, histoire: 2, ancien: 1 } }
      ]
    },
    { id: 17, acte: 3, year: 1794, title: "La chute de Robespierre", icon: "‚ö°",
      text: "9 <em>Thermidor</em>. Robespierre est guillotin√©.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Fin de la Terreur.</p>",
      choices: [
        { text: "Le tyran est mort ! Vive le roi !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Tant mieux que la Terreur soit finie.", scores: { lumieres: 2, histoire: 2, ancien: 0 } },
        { text: "Ce sont les corrompus qui l'ont abattu !", scores: { lumieres: 1, histoire: 0, ancien: 0 } },
        { text: "On va pouvoir respirer.", scores: { lumieres: 1, histoire: 2, ancien: 0 } }
      ]
    },
    { id: 18, acte: 4, year: 1795, title: "Le Directoire", icon: "üèõÔ∏è",
      text: "Le <em>Directoire</em> remplace la Convention.",
      question: "Ton avis ?",
      savoirPlus: "<p>R√©gime instable et corrompu.</p>",
      choices: [
        { text: "Sans roi, c'est le chaos.", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Au moins la Terreur est finie.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Ces bourgeois ont trahi la R√©volution !", scores: { lumieres: 2, histoire: 0, ancien: 0 } },
        { text: "Tant qu'on peut faire des affaires...", scores: { lumieres: 0, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 19, acte: 4, year: 1796, title: "Bonaparte en Italie", icon: "‚öîÔ∏è",
      text: "Bonaparte remporte victoire sur victoire.",
      question: "Que penses-tu de ce g√©n√©ral ?",
      savoirPlus: "<p>Il a 27 ans et devient un h√©ros.</p>",
      choices: [
        { text: "Un militaire trop puissant est dangereux.", scores: { lumieres: 2, histoire: 0, ancien: 0 } },
        { text: "Enfin un homme fort !", scores: { lumieres: 0, histoire: 2, ancien: 1 } },
        { text: "Il va peut-√™tre restaurer la monarchie.", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Quand aurons-nous la paix ?", scores: { lumieres: 1, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 20, acte: 4, year: 1799, title: "Le 18 Brumaire", icon: "üé≠",
      text: "Bonaparte renverse le Directoire par un <em>coup d'√âtat</em>.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>'La R√©volution est fix√©e... elle est finie.'</p>",
      choices: [
        { text: "C'est la mort de la libert√© !", scores: { lumieres: 2, histoire: 0, ancien: 0 } },
        { text: "Enfin un homme fort !", scores: { lumieres: 0, histoire: 2, ancien: 1 } },
        { text: "Il va restaurer le roi ?", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Attendons de voir.", scores: { lumieres: 1, histoire: 2, ancien: 0 } }
      ]
    },
    { id: 21, acte: 5, year: 1801, title: "Le Concordat", icon: "‚õ™",
      text: "Bonaparte signe le <em>Concordat</em> avec le pape.",
      question: "Qu'en penses-tu ?",
      savoirPlus: "<p>Paix religieuse retrouv√©e.</p>",
      choices: [
        { text: "On peut enfin pratiquer !", scores: { lumieres: 0, histoire: 1, ancien: 2 } },
        { text: "Compromis intelligent.", scores: { lumieres: 1, histoire: 2, ancien: 0 } },
        { text: "Bonaparte trahit la R√©volution !", scores: { lumieres: 2, histoire: 0, ancien: 0 } },
        { text: "Tant qu'on ne m'oblige pas...", scores: { lumieres: 1, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 22, acte: 5, year: 1804, title: "Le sacre", icon: "üëë",
      text: "Napol√©on se couronne empereur.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Il pose lui-m√™me la couronne sur sa t√™te.</p>",
      choices: [
        { text: "Le vrai roi est Louis XVIII !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "La R√©publique est morte.", scores: { lumieres: 2, histoire: 1, ancien: 0 } },
        { text: "Vive l'Empereur !", scores: { lumieres: 0, histoire: 2, ancien: 0 } },
        { text: "Roi ou empereur, quelle diff√©rence ?", scores: { lumieres: 0, histoire: 1, ancien: 1 } }
      ]
    },
    { id: 23, acte: 5, year: 1805, title: "Austerlitz", icon: "‚öîÔ∏è",
      text: "Napol√©on √©crase les Autrichiens et les Russes.",
      question: "Ta r√©action ?",
      savoirPlus: "<p>Le 'soleil d'Austerlitz' - chef d'≈ìuvre tactique.</p>",
      choices: [
        { text: "L'ambition d'un seul homme...", scores: { lumieres: 2, histoire: 0, ancien: 1 } },
        { text: "Gloire √† l'Empereur !", scores: { lumieres: 0, histoire: 2, ancien: 0 } },
        { text: "Mon fils est mort l√†-bas.", scores: { lumieres: 1, histoire: 0, ancien: 0 } },
        { text: "Quand aurons-nous la paix ?", scores: { lumieres: 2, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 24, acte: 5, year: 1806, title: "Le blocus continental", icon: "üö¢",
      text: "Napol√©on interdit le commerce avec l'Angleterre.",
      question: "Comment t'adaptes-tu ?",
      savoirPlus: "<p>L'Europe souffre, l'industrie sucri√®re se d√©veloppe.</p>",
      choices: [
        { text: "L'Empereur sait ce qu'il fait.", scores: { lumieres: 0, histoire: 2, ancien: 0 } },
        { text: "Mon commerce est ruin√© !", scores: { lumieres: 1, histoire: 0, ancien: 1 } },
        { text: "Je fais de la contrebande.", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Je me reconvertis.", scores: { lumieres: 0, histoire: 2, ancien: 0 } }
      ]
    },
    { id: 25, acte: 5, year: 1812, title: "La campagne de Russie", icon: "‚ùÑÔ∏è",
      text: "D√©sastre en Russie. Moins de 100 000 survivants sur 600 000.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>La B√©r√©zina devient synonyme de catastrophe.</p>",
      choices: [
        { text: "L'orgueil de Napol√©on a tu√© nos fils.", scores: { lumieres: 2, histoire: 1, ancien: 1 } },
        { text: "L'Empereur a √©t√© trahi.", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "C'est la fin.", scores: { lumieres: 1, histoire: 2, ancien: 1 } },
        { text: "Mon fr√®re n'est pas revenu.", scores: { lumieres: 2, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 26, acte: 5, year: 1814, title: "L'abdication", icon: "üìú",
      text: "Napol√©on abdique. Louis XVIII revient.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Exil √† l'√Æle d'Elbe.</p>",
      choices: [
        { text: "Le roi l√©gitime est de retour !", scores: { lumieres: 0, histoire: 1, ancien: 2 } },
        { text: "Tout √ßa pour √ßa...", scores: { lumieres: 2, histoire: 1, ancien: 0 } },
        { text: "Napol√©on reviendra.", scores: { lumieres: 0, histoire: 2, ancien: 0 } },
        { text: "Je veux juste la paix.", scores: { lumieres: 1, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 27, acte: 6, year: 1815, title: "Les Cent-Jours", icon: "ü¶Ö",
      text: "Napol√©on s'√©vade et reconquiert le pouvoir.",
      question: "Comment r√©agis-tu ?",
      savoirPlus: "<p>Le vol de l'Aigle : reconqu√™te sans tirer un coup de feu.</p>",
      choices: [
        { text: "L'usurpateur est de retour !", scores: { lumieres: 0, histoire: 0, ancien: 2 } },
        { text: "Vive l'Empereur !", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Encore la guerre...", scores: { lumieres: 2, histoire: 1, ancien: 0 } },
        { text: "Attendons de voir qui gagne.", scores: { lumieres: 0, histoire: 2, ancien: 1 } }
      ]
    },
    { id: 28, acte: 6, year: 1815, title: "Waterloo", icon: "‚öîÔ∏è",
      text: "<em>Waterloo</em>. D√©faite finale.",
      question: "Comment te sens-tu ?",
      savoirPlus: "<p>50 000 morts en une journ√©e.</p>",
      choices: [
        { text: "Le tyran est vaincu !", scores: { lumieres: 0, histoire: 1, ancien: 2 } },
        { text: "La France a perdu sa gloire.", scores: { lumieres: 0, histoire: 1, ancien: 0 } },
        { text: "Enfin la paix !", scores: { lumieres: 2, histoire: 2, ancien: 0 } },
        { text: "Napol√©on √©tait un g√©nie.", scores: { lumieres: 0, histoire: 1, ancien: 0 } }
      ]
    },
    { id: 29, acte: 6, year: 1821, title: "Mort de Napol√©on", icon: "‚ö∞Ô∏è",
      text: "Napol√©on meurt √† <em>Sainte-H√©l√®ne</em>.",
      question: "Quel bilan tires-tu ?",
      savoirPlus: "<p>Son corps sera ramen√© aux Invalides en 1840.</p>",
      choices: [
        { text: "Bon d√©barras !", scores: { lumieres: 1, histoire: 0, ancien: 2 } },
        { text: "Un g√©ant de l'Histoire.", scores: { lumieres: 0, histoire: 2, ancien: 0 } },
        { text: "Il a trahi les id√©aux r√©volutionnaires.", scores: { lumieres: 2, histoire: 1, ancien: 0 } },
        { text: "L'Histoire jugera.", scores: { lumieres: 2, histoire: 2, ancien: 0 } }
      ]
    }
];

function generateGameCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
    return code;
}

document.getElementById('createGameBtn').addEventListener('click', async function() {
    gameCode = generateGameCode();
    gameRef = database.ref('games/' + gameCode);
    await gameRef.set({ status: 'waiting', currentSituation: 0, createdAt: Date.now(), players: {} });
    document.getElementById('createSection').classList.add('hidden');
    document.getElementById('waitingSection').classList.remove('hidden');
    document.getElementById('displayCode').textContent = gameCode;
    const joinUrl = window.location.href.replace('maitre', 'eleve') + '?code=' + gameCode;
    document.getElementById('joinUrl').textContent = joinUrl;
    QRCode.toCanvas(document.getElementById('qrCode'), joinUrl, { width: 180, margin: 2, color: { dark: '#002654' } });
    gameRef.child('players').on('value', (snapshot) => { players = snapshot.val() || {}; updatePlayersList(); });
});

function updatePlayersList() {
    const container = document.getElementById('playersWaiting');
    const names = Object.values(players).map(p => p.name);
    container.innerHTML = names.map(n => '<span class="player-chip">' + n + '</span>').join('');
    document.getElementById('playerCountSetup').textContent = names.length;
    document.getElementById('startGameBtn').disabled = names.length < 1;
}

document.getElementById('startGameBtn').addEventListener('click', async function() {
    await gameRef.update({ status: 'playing', currentSituation: 0 });
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    document.getElementById('headerCode').textContent = gameCode;
    renderSituation();
    listenToResponses();
});

function addTooltips(text) {
    return text.replace(/<em>([^<]+)<\/em>/g, function(m, t) {
        const d = definitions[t];
        return d ? '<span class="term" data-def="' + d.replace(/"/g, '&quot;') + '">' + t + '</span>' : '<span class="term">' + t + '</span>';
    });
}

function renderSituation() {
    const s = situations[currentSituation];
    const a = actes.find(x => x.id === s.acte);
    document.getElementById('situationYear').textContent = s.year;
    document.getElementById('situationActe').textContent = 'Acte ' + a.id + ' ‚Ä¢ ' + a.periode;
    document.getElementById('situationIcon').textContent = s.icon;
    document.getElementById('situationTitle').textContent = s.title;
    document.getElementById('situationText').innerHTML = addTooltips(s.text).replace(/\n/g, '<br>');
    document.getElementById('situationQuestion').textContent = s.question;
    const cl = document.getElementById('choicesList');
    cl.innerHTML = '';
    ['A','B','C','D'].forEach((l, i) => {
        if (s.choices[i]) {
            const d = document.createElement('div');
            d.className = 'choice-item';
            d.innerHTML = '<span class="choice-letter">' + l + '</span><span>' + s.choices[i].text + '</span>';
            cl.appendChild(d);
        }
    });
    if (s.savoirPlus) {
        document.getElementById('savoirPlusBox').classList.remove('hidden');
        document.getElementById('savoirPlusContent').innerHTML = s.savoirPlus;
    } else {
        document.getElementById('savoirPlusBox').classList.add('hidden');
    }
    const p = ((currentSituation + 1) / situations.length) * 100;
    document.getElementById('progressFill').style.width = p + '%';
    document.getElementById('progressText').textContent = (currentSituation + 1) + ' / ' + situations.length;
    document.getElementById('responsesCount').textContent = '0';
    document.getElementById('nextSituationBtn').disabled = true;
    if (gameRef) gameRef.update({ currentSituation });
    updateRankings();
}

function listenToResponses() {
    gameRef.child('players').on('value', (snapshot) => {
        players = snapshot.val() || {};
        let resp = 0;
        Object.values(players).forEach(p => { if (p.responses && p.responses[currentSituation] !== undefined) resp++; });
        const total = Object.keys(players).length;
        document.getElementById('responsesCount').textContent = resp;
        document.getElementById('totalPlayers').textContent = total;
        document.getElementById('playerCount').textContent = total;
        document.getElementById('nextSituationBtn').disabled = resp < total || total === 0;
        updateRankings();
    });
}

function updateRankings() {
    const scores = [];
    Object.entries(players).forEach(([id, p]) => {
        let l = 0, h = 0, a = 0;
        if (p.responses) {
            Object.entries(p.responses).forEach(([si, ci]) => {
                const sit = situations[parseInt(si)];
                if (sit && sit.choices[ci]) {
                    const sc = sit.choices[ci].scores;
                    l += sc.lumieres || 0;
                    h += sc.histoire || 0;
                    a += sc.ancien || 0;
                }
            });
        }
        scores.push({ name: p.name, lumieres: l, histoire: h, ancien: a });
    });
    renderRanking('rankingLumieres', scores.slice().sort((a, b) => b.lumieres - a.lumieres), 'lumieres');
    renderRanking('rankingHistoire', scores.slice().sort((a, b) => b.histoire - a.histoire), 'histoire');
    renderRanking('rankingAncien', scores.slice().sort((a, b) => b.ancien - a.ancien), 'ancien');
}

function renderRanking(id, sorted, key) {
    const c = document.getElementById(id);
    c.innerHTML = '';
    sorted.slice(0, 6).forEach((p, i) => {
        const li = document.createElement('li');
        li.className = 'ranking-item';
        let pc = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        li.innerHTML = '<span class="ranking-position ' + pc + '">' + (i + 1) + '</span><span class="ranking-name">' + p.name + '</span><span class="ranking-score">' + p[key] + '</span>';
        c.appendChild(li);
    });
}

document.getElementById('nextSituationBtn').addEventListener('click', function() {
    if (currentSituation < situations.length - 1) { currentSituation++; renderSituation(); }
    else showEndScreen();
});

function showEndScreen() {
    document.getElementById('gameScreen').classList.add('hidden');
    document.getElementById('endScreen').classList.remove('hidden');
    const scores = [];
    Object.entries(players).forEach(([id, p]) => {
        let l = 0, h = 0, a = 0;
        if (p.responses) {
            Object.entries(p.responses).forEach(([si, ci]) => {
                const sit = situations[parseInt(si)];
                if (sit && sit.choices[ci]) { l += sit.choices[ci].scores.lumieres || 0; h += sit.choices[ci].scores.histoire || 0; a += sit.choices[ci].scores.ancien || 0; }
            });
        }
        scores.push({ name: p.name, lumieres: l, histoire: h, ancien: a });
    });
    const lTop = scores.slice().sort((a, b) => b.lumieres - a.lumieres);
    const hTop = scores.slice().sort((a, b) => b.histoire - a.histoire);
    const aTop = scores.slice().sort((a, b) => b.ancien - a.ancien);
    const avgL = scores.reduce((s, p) => s + p.lumieres, 0) / scores.length || 0;
    const avgH = scores.reduce((s, p) => s + p.histoire, 0) / scores.length || 0;
    const avgA = scores.reduce((s, p) => s + p.ancien, 0) / scores.length || 0;
    let tendency = avgH > avgL && avgH > avgA ? "üéØ Votre classe suit le cours de l'Histoire." : avgL > avgH && avgL > avgA ? "üèõÔ∏è Votre classe est fid√®le aux id√©aux des Lumi√®res." : "üëë Votre classe d√©fend l'ordre traditionnel.";
    
    document.getElementById('endScreen').innerHTML = '<h1 class="end-title">üèõÔ∏è Fin de la partie</h1>' +
        '<div class="final-rankings">' +
        '<div class="final-ranking-card lumieres"><div class="ranking-header"><span class="ranking-icon">üèõÔ∏è</span><span class="ranking-title">Lumi√®res</span></div><div class="podium">' +
        (lTop[1] ? '<div class="podium-place second"><div class="podium-name">' + lTop[1].name + '</div><div class="podium-score">' + lTop[1].lumieres + '</div></div>' : '') +
        (lTop[0] ? '<div class="podium-place first"><div class="podium-name">' + lTop[0].name + '</div><div class="podium-score">' + lTop[0].lumieres + '</div></div>' : '') +
        (lTop[2] ? '<div class="podium-place third"><div class="podium-name">' + lTop[2].name + '</div><div class="podium-score">' + lTop[2].lumieres + '</div></div>' : '') +
        '</div></div>' +
        '<div class="final-ranking-card histoire"><div class="ranking-header"><span class="ranking-icon">üìú</span><span class="ranking-title">Histoire</span></div><div class="podium">' +
        (hTop[1] ? '<div class="podium-place second"><div class="podium-name">' + hTop[1].name + '</div><div class="podium-score">' + hTop[1].histoire + '</div></div>' : '') +
        (hTop[0] ? '<div class="podium-place first"><div class="podium-name">' + hTop[0].name + '</div><div class="podium-score">' + hTop[0].histoire + '</div></div>' : '') +
        (hTop[2] ? '<div class="podium-place third"><div class="podium-name">' + hTop[2].name + '</div><div class="podium-score">' + hTop[2].histoire + '</div></div>' : '') +
        '</div></div>' +
        '<div class="final-ranking-card ancien"><div class="ranking-header"><span class="ranking-icon">üëë</span><span class="ranking-title">Ancien R√©gime</span></div><div class="podium">' +
        (aTop[1] ? '<div class="podium-place second"><div class="podium-name">' + aTop[1].name + '</div><div class="podium-score">' + aTop[1].ancien + '</div></div>' : '') +
        (aTop[0] ? '<div class="podium-place first"><div class="podium-name">' + aTop[0].name + '</div><div class="podium-score">' + aTop[0].ancien + '</div></div>' : '') +
        (aTop[2] ? '<div class="podium-place third"><div class="podium-name">' + aTop[2].name + '</div><div class="podium-score">' + aTop[2].ancien + '</div></div>' : '') +
        '</div></div></div>' +
        '<div class="class-stats"><h2 class="stats-title">üìä Statistiques de la classe</h2><div class="stats-grid">' +
        '<div class="stat-item"><div class="stat-value">' + scores.length + '</div><div class="stat-label">Joueurs</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + avgL.toFixed(1) + '</div><div class="stat-label">Moy. Lumi√®res</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + avgH.toFixed(1) + '</div><div class="stat-label">Moy. Histoire</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + avgA.toFixed(1) + '</div><div class="stat-label">Moy. Ancien R.</div></div></div>' +
        '<p style="text-align:center;margin-top:1rem;opacity:0.8;">' + tendency + '</p></div>' +
        '<div style="text-align:center;margin-top:2rem;"><button class="btn btn-primary" onclick="location.reload()">Nouvelle partie</button></div>';
}
</script>
</body>
</html>
